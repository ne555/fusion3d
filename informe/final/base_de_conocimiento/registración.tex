\section{Registración}
Al finalizar la etapa de adquisición se obtuvo una nube de puntos
que representaba la porción observada del objeto.
Para lograr una reconstrucción total del objeto es necesario combinar múltiples capturas
variando la posición relativa cámara-objeto.
Contar con un dispositivo que nos permita definir con precisión
tanto la posición como orientación de la cámara es altamente costoso,
por esta razón, en la etapa de registración se calcularán las transformaciones que ubiquen cada
captura en un sistema de referencia global, de forma que las zonas comunes encajen perfectamente.


La operación de registración se realizará siempre entre dos capturas,
buscando las transformaciones de translación y rotación que ubiquen
la captura de partida en el marco de referencia de la captura objetivo.
De esta manera, el problema general cuenta con seis grados de libertad.
Primero se discutirá el caso donde la transformación de alineación sea pequeña,
luego se permitirán incrementos mayores,
y finalmente se extenderá el proceso para abarcar $n$ capturas.

%esto va en $N$ capturas
%Para extender este proceso a $n$ capturas, puede alinearse $C_0$ con $C_1$,
%$C_1$ con $C_2$, $C_2$ con $C_3$, etc.,
%sin embargo, el error de registración se propagará en cada paso.


\subsection{Perturbaciones pequeñas: algoritmo iterativo del punto más cercano (ICP)}
Antes de describir este algoritmo, se planteará una versión simplificada del problema
que nos permitirá establecer ciertas definiciones.

Supongamos que a una nube $A$ le aplicamos una transformación de translación y rotación arbitraria,
y luego aplicamos una pequeña perturbación a las posiciones de los puntos transformados,
obteniendo así la nube $B$.
Se observa ambas nubes poseen la misma cardinalidad y podemos establecer las relaciones de origen a destino
$a_j \to b_j$ para cada punto $a_j \in A$.
Se puede definir el error de alineación como
\[
	\text{Error} = \frac{1}{N} \sum_{j=1}^n || b_j - T \left(a_j\right) ||
\]
y se buscará la transformación $T$ que minimice este error.
Existe una solución cerrada para este problema, obteniéndose la rotación al
calcular los eigenvectores de una matriz simétrica de $4\times4$,
cuyos detalles pueden consultarse en \cite{Horn87closed-formsolution}.

Sin embargo, estas suposiciones son demasiado fuertes.
Al trabajar con dos capturas realizadas desde distintas vistas, el solapamiento no será total,
ya que habrá puntos que serán observables en tan sólo uno de las vistas,
por lo que primero es necesario determinar cuáles son los puntos comunes.
Además, se desconoce para los puntos de la nube $A$ cuál es su posición en $B$.
El algoritmo iterativo del punto más cercano (ICP) supone que las nubes se encuentran
lo suficientemente cerca como para establecer estas correspondencias mediante las coordenadas de los puntos.
El algoritmo se describe de la siguiente manera:
\begin{enumerate}
	\item Obtener las correspondencias:
		Para cada punto $a_j \in A$ buscar el punto más cercano en la nube $B$.
		Si la distancia entre esos puntos supera un umbral $d_{\text{max}}$,
		se considera que $a_j$ no pertenece a la zona común y no es considerado en esta iteración.
	\item Calcular la transformación que alinee los pares de puntos de la zona común.
	\item Aplicar la transformación.
	\item Repetir el proceso hasta que el error de alineación esté por debajo de un umbral $\tau$.
\end{enumerate}%\cite{conf/rss/SegalHT09}
Si bien el algoritmo convergirá a un mínimo local, puede que este no sea el mínimo global buscado.
Debe cumplirse la suposición de cercanía para obtener una correcta registración.\cite{regBesl92}

%generalized conf/rss/SegalHT09
En \cite{chen-medoni} se presenta una variante del algoritmo de ICP llamada ICP punto-a-plano,
que resulta más robusta y precisa al trabajar con nubes de puntos en 2.5D. \TODO{definir 2.5D, que es lo que tenemos}
Una vez establecida una correspondencia $a_j \to b_j$, si bien no se trata del mismo punto,
se realiza la suposición de que pertenecen al mismo plano.
Por esta razón, podemos decir que conocemos con mucha confianza la posición del punto
a lo largo de su normal, pero no su ubicación en el plano.
Para reflejar esto, se cambia la métrica del error, proyectando el punto transformado sobre la normal
del punto destino (figura~\ref{fig:point_to_plane}).
\[
	\text{Error} = \frac{1}{N} \sum_{j=1}^n || n_j \cdot \left( b_j - T \left(a_j\right) \right) ||
\]

\begin{figure}
	\centering
	\input{diagram/icp_point_to_plane.pdf_tex}
	\caption{\label{fig:point_to_plane}Medidas de error punto-a-plano entre dos superficies
	(Imagen cortesía de \cite{icp_point_to_plane}).}
\end{figure}


\subsection{Distancias mayores: búsqueda de correspondencias mediante vectores de características}
Cuando la transformación de alineación requerida para alinear las dos nubes de puntos
no es lo suficientemente pequeña, no se obtiene una buena aproximación al establecer las correspondencias
utilizando únicamente las posiciones de los puntos.
Una posibilidad es emplear métodos semiautomáticos, donde el usuario proveerá de una alineación inicial
de las nubes o determinará las correspondencias seleccionando puntos de ambas nubes.
Sin embargo, este es un método lento y engorroso,
por lo que surge la necesidad de plantear un algoritmo completamente automático.

Para hallar las correspondencias de manera automática, se calculará un vector de características o \emph{descriptor}
sobre una vecindad de cada punto. Al comparar luego los descriptores con alguna medida de distancia,
si la distancia es pequeña (cercana a $0$), entonces las vecindades son similares
y podría plantearse una correspondencia entre los puntos.
Un buen descriptor deberá poseer las siguientes características:
\begin{itemize}
	\item Ser discriminante, es decir, la distancia entre los descriptores deberá reflejar
		la distancia entre las superficies de las vecindades.
		Es decir, en superficies similares se obtendrán descriptores parecidos y
		en superficies diferentes habrá una gran distancia entre los descriptores (figura~\ref{fig:descriptor_matriz_confusion}).
	\item Ser invariante respecto a translaciones y rotaciones.
	\item Ser robusto respecto al ruido de muestreo.
	\item Ser robusto respecto a la densidad de muestreo.
	\item Ser robusto respecto a la ausencia de muestras debido a oclusiones.
\end{itemize}

\begin{figure}
	\Imagen{foo}
	\caption{\label{fig:descriptor_matriz_confusion}Matriz de confusión del descriptor FPFH para distintas clases de superficies \RefImagen{RusuDoctoralDissertation}.}
\end{figure}

Además de la elección del descriptor, un parámetro importante a determinar es
el tamaño de la vecindad que éste representará.
En general, la vecindad de un punto $p$ incluye a todos aquellos puntos $q$
que se encuentran dentro de una esfera de radio $r$ centrada en $p$:
\[ |p - q| \leq r \]
Si el valor de $r$ es demasiado pequeño, el descriptor perderá su poder discriminante
o incluso no podrá calcularse al no contar con la cantidad de vecinos mínimos necesarios.
En cambio, si el valor de $r$ es demasiado grande, se corre el riesgo de considerar
dentro de la vecindad puntos pertenecientes a otra superficie, distorsionando el valor del descriptor.
La determinación de un valor adecuado de $r$ limita la posibilidad de obtener un método completamente
automático para el cálculo de los descriptores\cite{RusuDoctoralDissertation}.
 %This issue is of extreme importance and constitutes a limiting factor in the automatic estimation (i.e., without user given thresholds) of a point feature representation.


\subsubsection{Estimación de las normales}
Para poder describir la geometría de la superficie,
primero debe estimarse su orientación en el sistema de coordenadas, es decir, estimar su normal.
Una opción es aproximar la normal mediante la estimación de un plano tangente a la superficie,
lo que transforma el problema a ajustar un plano a la vecindad de $p$
mediante el método de mínimos cuadrados. 
Representando el plano mediante un punto $x_j$ y un vector normal $n_j$,
la distancia de un punto $q$ de la vecindad a este plano queda definida como
$d = (q_j - x_j) n_j$.
Para minimizar la sumatoria del cuadrado de todas las distancias, se tiene que:
\[x_j = \frac{1}{N} \sum_{k=1}^{N} q^{(k)}_j \]
para los $N$ puntos de la vecindad de $p$.
Y para obtener $n_j$ se analizan los eigenvalores y eigenvectores de la matriz de covarianza de la vecindad:
\[ C_{jk} = \sum_{r=1}{N} (q^{(r)}_j - x_j) (q^{(r)}_k - x_k) \]

Se observa que $C_{jk}$ es una matriz simétrica y por lo tanto todos sus eigenvalores son reales
$\lambda_j \in \Real$.
El eigenvector que corresponde al eigenvalor de menor magnitud corresponde a la normal del plano tangente,
es decir a $+n_j$ o a $-n_j$\cite{10.1109/34.334391}.
Si bien no puede determinarse matemáticamente el signo de $n_j$,
\TODO{ver lo de 2.5D, explicar antes}
puede resolverse la ambigüedad al considerar que la nube de puntos que se obtiene del proceso de adquisición
es 2.5D y se conoce la ubicación de la cámara $v_j$ en un sistema de referencia local.
Por lo tanto, debe cumplirse que:
\[n_j v_j > 1\]
y se invertirá el signo de $n_j$ en caso de ser necesario.

\subsubsection{Histograma de características del punto (PFH)}
Además de que las normales no son invariantes a rotaciones, no capturan mucho
detalle de la superficie y, por lo tanto, no presentan un gran poder
discriminante. Por estas razones, no resulta adecuado utilizarlas como único descriptor. 
Sin embargo, al representar las relaciones entre todos los puntos de la vecindad y sus normales,
pueden capturarse con más detalle las variaciones de la superficie,
aumentando la representatividad del descriptor. 
Esta es la idea principal del histograma de características del punto (PFH) presentado en \cite{RusuDoctoralDissertation}.

El vector de características de PFH es un histograma de los valores de tres ángulos
y una distancia calculados para cada par de puntos y sus normales en la vecindad de $p$.
Para asegurar la replicabilidad del descriptor, se define un marco de referencia de Darboux
determinado unívocamente de la siguiente manera:
\[
	\vec{n}_j \cdot (p_k - p_j) > \vec{n}_k \cdot (p_j - p_k)
			\begin{cases}
				\text{Verdadero: }& p_s = p_j \quad p_t = p_k\\
				\text{Falso: }& p_s = p_k \quad p_t = p_j\\
			\end{cases}
\]
\[
	\begin{cases}
		u =& n_s \\
		v =& u \times \displaystyle\frac{p_t - p_s}{|p_t - p_s|} \\
		w =& u \times v \\
	\end{cases}
\]
Y entonces se procede a calcular las siguientes relaciones para estos puntos:
	\begin{align*}
		d        &= |p_t - p_s| \\
		\alpha   &= v \cdot n_t \\
		\phi     &= u \cdot \frac{p_t - p_s}{d}\\
		\theta   &= \atan(w \cdot n_t, u \cdot n_t)
	\end{align*}
Sin embargo, la distancia entre puntos $d$ no es de importancia para escaneos 2.5D,
ya que la distancia entre vecinos se incrementa con la distancia a la cámara,
y suele ser beneficioso omitirla en estos casos \cite{RusuDoctoralDissertation}.

%propio
Para entender el poder discriminante del descriptor PFH, es preciso comprender el significado
de los ángulos calculados entre los pares de puntos.
Considerando el plano tangente a $p_s$, el ángulo $\phi$ mide la separación de la posición de $p_t$ respecto a este plano.
Luego, considerando el plano donde se encuentran $p_s$, $p_t$ y $n_s$, y cuya normal es $v$:
\begin{itemize}
	\item el ángulo $\alpha$ medirá el desvío de la normal $n_t$ respecto a este plano,
	\item el ángulo $\theta$ medirá la distancia entre las proyecciones de las normales sobre este plano.
\end{itemize}
De esta manera, se logra describir con buen detalle las características de la superficie en la vecindad de cada punto.



\begin{figure}
	\Imagen{foo}
	\caption{\label{fig:pfh_marco_referencia}Representación gráfica del marco de Darboux y las características calculadas por el descriptor PFH \RefImagen{RusuDoctoralDissertation}.}
\end{figure}

\begin{figure}
	\Imagen{foo}
	\caption{\label{fig:pfh_angulos}Representación gráfica de los ángulos calculados por el descriptor PFH.}
\end{figure}

\subsubsection{PFH rápido (FPFH)}
Debido a que para obtener el descriptor PFH de un punto es necesario calcular
las relaciones entre todos los pares de puntos de su vecindad,
el orden de ejecución para una nube con $n$ puntos es $\bigO(nk^2)$,
donde $k$ es la cantidad de puntos en la vecindad,
y por esta razón el cálculo de este descriptor puede convertirse
en uno de los cuellos de botella del proceso.

Para solventar este problema, en \cite{Rusu:2009:FPF:1703435.1703733} se propone
una simplificación del descriptor PFH, llamada PFH rápido o simplemente FPFH,
que nos permite reducir el tiempo de ejecución a $\bigO(n^2)$
manteniendo el poder descriptivo de PFH.

El cálculo de este nuevo descriptor se realiza de la siguiente manera:
\begin{enumerate}
	\item Calcular por cada punto $p$ y sus vecinos las tuplas $\langle \alpha, \phi, \theta \rangle$,
		llamamos a estas características PFH simplificado (SPFH).
	\item Realizar un promedio ponderado de los valores del SPFH de $p$ y sus vecinos:
		\[
			FPFH(p) = SPFH(p) + \frac{1}{N} \sum_{j=1}^{N} \frac{1}{w_j} SPFH(p_j)
		\]
		donde $w_j$ es una medida de distancia entre $p$ y su vecino.
\end{enumerate}
Las principales diferencias respecto a PFH son:
\begin{itemize}
	\item FPFH no interconecta todos los vecinos de $p$.
	\item FPFH puede incluir puntos fuera del radio $r$ de vecindad, pero no a más de $2r$.
\end{itemize}


\subsubsection{Puntos salientes (\emph{keypoints})}
Al describir las características de un buen descriptor, mencionamos la capacidad discriminante del mismo.
Se presenta una gran diferencia entre descriptores de superficies diferentes,
pero la distancia es cercana a $0$ en superficies parecidas,
y de esta forma se pueden establecer las correspondencias entre los puntos de dos nubes
al comparar sus descriptores.

Al analizar una zona homogénea en una nube, como, por ejemplo, un plano,
todos los puntos presentarán descriptores parecidos.
Surgen problemas al intentar establecer una correspondencia entre estos puntos
y los presentes en la otra nube, ya que todos son candidatos igualmente válidos.

Para solucionar este problema, es necesario identificar puntos salientes (\emph{keypoints}) 
en la nube, para entonces establecer las correspondencias entre los descriptores de estos keypoints.
Si bien un punto cualquiera será considerado como saliente o no dependiendo del detector utilizado,
un buen detector presentará las siguientes características:
\begin{itemize}
	\item Dispersión: un subconjunto pequeño de los puntos de la nube serán considerados como keypoints.
	\item Repetebilidad: un keypoint deberá ser detectado en la misma ubicación
		sobre el objeto sin importar la posición de la cámara al realizar la captura.
	\item Distinguibilidad: la superficie en la vecindad del keypoint
		presentará características únicas que serán capturadas por un descriptor.
\end{itemize}

Como ejemplos de detectores se puede mencionar el detector de esquinas Harris,
el cual puede ser adaptado de trabajar en imágenes a trabajar en el espacio
traduciendo cambios en la intensidad de píxeles por ángulos entre las normales de puntos vecinos;
y el detector ISS, que analiza los eigenvalores de la matriz de covarianza en la vecindad de un punto.
